import sqlite3
import sys
import tkinter as tk
from tkinter import messagebox
import subprocess
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
import os
import webbrowser


def fetch_user_travel_history(user_id):
    conn = sqlite3.connect("iexplore.db")
    cursor = conn.cursor()

    cursor.execute("""
        SELECT 
            t.trip_id,
            t.destination,
            t.start_date,
            t.end_date,
            t.price,
            b.status
        FROM bookings b
        JOIN travel_offers t ON b.offer_id = t.offer_id
        WHERE b.user_id = ?
        ORDER BY t.start_date DESC
    """, (user_id,))

    history = cursor.fetchall()
    conn.close()
    return history


def fetch_reviews_for_trip(trip_id):
    conn = sqlite3.connect("iexplore.db")
    cursor = conn.cursor()

    cursor.execute("""
        SELECT r.rating, r.comment, u.username
        FROM trip_reviews r
        JOIN users u ON r.user_id = u.user_id
        WHERE r.trip_id = ?
    """, (trip_id,))

    reviews = cursor.fetchall()
    conn.close()
    return reviews


def submit_review(user_id, trip_id, rating, comment):
    conn = sqlite3.connect("iexplore.db")
    cursor = conn.cursor()

    try:
        cursor.execute("""
            INSERT INTO trip_reviews (user_id, trip_id, rating, comment)
            VALUES (?, ?, ?, ?)
        """, (user_id, trip_id, rating, comment))
        conn.commit()
        messagebox.showinfo("Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±", "Î— Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!")
        generate_pdf(user_id, trip_id, rating, comment)  # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF
    except sqlite3.Error as e:
        messagebox.showerror("Î£Ï†Î¬Î»Î¼Î±", f"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚: {e}")
    finally:
        conn.close()


def generate_pdf(user_id, trip_id, rating, comment):
    # Î›Î®ÏˆÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Ï„Î¿Ï… Ï„Î±Î¾Î¹Î´Î¹Î¿Ï Î³Î¹Î± Ï„Î¿ PDF
    conn = sqlite3.connect("iexplore.db")
    cursor = conn.cursor()
    cursor.execute("""
        SELECT t.destination, t.start_date, t.end_date
        FROM travel_offers t
        WHERE t.trip_id = ?
    """, (trip_id,))
    trip_data = cursor.fetchone()
    conn.close()

    destination = trip_data[0]
    start_date = trip_data[1]
    end_date = trip_data[2]

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF
    filename = f"review_{user_id}_{trip_id}.pdf"
    c = canvas.Canvas(filename, pagesize=letter)

    c.setFont("Helvetica", 12)
    c.drawString(100, 750, f"Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î¤Î±Î¾Î¹Î´Î¹Î¿Ï: {destination}")
    c.drawString(100, 730, f"Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎˆÎ½Î±ÏÎ¾Î·Ï‚: {start_date}")
    c.drawString(100, 710, f"Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î›Î®Î¾Î·Ï‚: {end_date}")
    c.drawString(100, 690, f"Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±: {rating} Î‘ÏƒÏ„Î­ÏÎ¹Î±")
    c.drawString(100, 670, f"Î£Ï‡ÏŒÎ»Î¹Î¿: {comment}")

    c.save()

    # Î†Î½Î¿Î¹Î³Î¼Î± Ï„Î¿Ï… PDF Î¼Îµ Ï„Î·Î½ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
    webbrowser.open(filename)


class TravelHistoryApp:
    def __init__(self, root, user_id):
        self.root = root
        self.root.title("ğŸ“– Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î¤Î±Î¾Î¹Î´Î¹ÏÎ½")
        self.root.geometry("700x500")
        self.user_id = user_id

        self.display_travel_history()

    def display_travel_history(self):
        history = fetch_user_travel_history(self.user_id)

        if not history:
            tk.Label(self.root, text="Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î± Ï„Î±Î¾Î¯Î´Î¹Î±.",
                     font=("Arial", 14)).pack(pady=20)
            return

        tk.Label(self.root, text="Î¤Î±Î¾Î¯Î´Î¹Î± Ï€Î¿Ï… Î­Ï‡ÎµÎ¹Ï‚ ÎºÎ¬Î½ÎµÎ¹ ÎºÏÎ¬Ï„Î·ÏƒÎ·:", font=("Arial", 16, "bold")).pack(pady=10)

        frame = tk.Frame(self.root)
        frame.pack(pady=10)

        headers = ["Î ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚", "ÎˆÎ½Î±ÏÎ¾Î·", "Î›Î®Î¾Î·", "Î¤Î¹Î¼Î® (â‚¬)", "ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·", "Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·"]
        for col, header in enumerate(headers):
            tk.Label(frame, text=header, font=("Arial", 10, "bold"), width=15, borderwidth=1, relief="solid").grid(
                row=0, column=col)

        for row_idx, (trip_id, destination, start_date, end_date, price, status) in enumerate(history, start=1):
            tk.Label(frame, text=destination, width=15, borderwidth=1, relief="solid").grid(row=row_idx, column=0)
            tk.Label(frame, text=start_date, width=15, borderwidth=1, relief="solid").grid(row=row_idx, column=1)
            tk.Label(frame, text=end_date, width=15, borderwidth=1, relief="solid").grid(row=row_idx, column=2)
            tk.Label(frame, text=f"{price:.2f} â‚¬", width=15, borderwidth=1, relief="solid").grid(row=row_idx, column=3)
            tk.Label(frame, text=status, width=15, borderwidth=1, relief="solid").grid(row=row_idx, column=4)

            review_button = tk.Button(frame, text="Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·", width=15,
                                      command=lambda trip_id=trip_id: self.show_review_form(trip_id))
            review_button.grid(row=row_idx, column=5)

        # Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚ ÏƒÏ„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ Î¼ÎµÎ½Î¿Ï
        back_button = tk.Button(self.root, text="Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ ÎšÎµÎ½Ï„ÏÎ¹ÎºÏŒ ÎœÎµÎ½Î¿Ï", command=self.return_to_dashboard)
        back_button.pack(pady=20)

    def show_review_form(self, trip_id):
        review_window = tk.Toplevel(self.root)
        review_window.title("Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î¤Î±Î¾Î¹Î´Î¹Î¿Ï")

        tk.Label(review_window, text="Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎµ Ï„Î¿ Ï„Î±Î¾Î¯Î´Î¹ (1-5 Î±ÏƒÏ„Î­ÏÎ¹Î±):").pack(pady=10)

        rating_var = tk.IntVar()
        rating_var.set(1)

        for i in range(1, 6):
            tk.Radiobutton(review_window, text=f"{i} Î‘ÏƒÏ„Î­ÏÎ¹Î±", variable=rating_var, value=i).pack()

        tk.Label(review_window, text="Î£Ï‡ÏŒÎ»Î¹Î±:").pack(pady=10)
        comment_entry = tk.Entry(review_window, width=50)
        comment_entry.pack(pady=5)

        def submit_review_action():
            rating = rating_var.get()
            comment = comment_entry.get()
            submit_review(self.user_id, trip_id, rating, comment)
            review_window.destroy()
            self.display_travel_history()

        tk.Button(review_window, text="Î¥Ï€Î¿Î²Î¿Î»Î®", command=submit_review_action).pack(pady=10)
        tk.Button(review_window, text="Î‘ÎºÏÏÏ‰ÏƒÎ·", command=review_window.destroy).pack(pady=5)

    def return_to_dashboard(self):
        try:
            subprocess.Popen([sys.executable, "user_dashboard.py"])  # Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· Ï„Î¿Ï… user_dashboard.py
            self.root.destroy()  # ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Ï„Î¿Ï… Ï€Î±ÏÎ±Î¸ÏÏÎ¿Ï… travel_history.py
        except Exception as e:
            messagebox.showerror("Î£Ï†Î¬Î»Î¼Î±", f"Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·Ï‚ Ï„Î¿Ï… ÎºÎµÎ½Ï„ÏÎ¹ÎºÎ¿Ï Î¼ÎµÎ½Î¿Ï:\n{e}")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        messagebox.showerror("Î£Ï†Î¬Î»Î¼Î±", "Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ user_id Î³Î¹Î± Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ.")
        sys.exit(1)

    try:
        user_id = int(sys.argv[1])
    except ValueError:
        messagebox.showerror("Î£Ï†Î¬Î»Î¼Î±", "ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ user_id!")
        sys.exit(1)

    root = tk.Tk()
    app = TravelHistoryApp(root, user_id)
    root.mainloop()
